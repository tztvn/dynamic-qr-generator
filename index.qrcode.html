<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic QR Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-animation {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .qr-data {
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex flex-col items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl p-8 space-y-6">
        <!-- Header -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Dynamic QR Generator</h1>
            <p class="text-gray-600">Secure Time-Based Authentication</p>
        </div>

        <!-- QR Code Container -->
        <div class="flex flex-col items-center space-y-4">
            <div id="qrcode" class="p-4 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
                <div class="w-64 h-64 flex items-center justify-center">
                    <div class="text-gray-400 text-center">
                        <svg class="w-16 h-16 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                        </svg>
                        <p class="text-sm">Syncing time...</p>
                    </div>
                </div>
            </div>
            
            <!-- Status Indicator -->
            <div class="flex items-center space-x-2">
                <div id="status" class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                <span id="timer" class="text-sm text-gray-600">Syncing time...</span>
            </div>
        </div>

        <!-- QR Data Display -->
        <div class="bg-indigo-50 rounded-lg p-4">
            <div class="text-sm text-gray-600 mb-1">QR Data:</div>
            <div id="qrData" class="qr-data text-indigo-800 font-semibold text-sm break-all">-</div>
        </div>

        <!-- Info Section -->
        <div class="bg-blue-50 rounded-lg p-4 space-y-2">
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">Card ID:</span>
                <span id="cardId" class="font-mono text-gray-800">V006275907</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">Timestamp:</span>
                <span id="timestamp" class="font-mono text-gray-800">-</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">Dynamic Part:</span>
                <span id="dynamicPart" class="font-mono text-gray-800">-</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-600">Time Source:</span>
                <span id="timeSource" class="font-mono text-gray-800">Server</span>
            </div>
        </div>

        <!-- Refresh Button -->
        <button onclick="generateQR()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 transform hover:scale-105 active:scale-95">
            Generate New QR
        </button>
    </div>

    <!-- Footer -->
    <footer class="mt-8 text-center">
        <p class="text-gray-600 text-sm">Developed by</p>
        <p class="text-indigo-600 font-semibold">soueib the developer</p>
    </footer>

    <script>
        const CARD_ID = "V006275907";
        let serverTimeOffset = 0;
        let countdown = 5;
        let countdownInterval;
        let timeSyncInterval;

        // Get accurate time from world time API
        async function syncServerTime() {
            try {
                const response = await fetch('https://worldtimeapi.org/api/timezone/Etc/UTC');
                const data = await response.json();
                const serverTime = new Date(data.datetime).getTime();
                const localTime = Date.now();
                serverTimeOffset = serverTime - localTime;
                
                document.getElementById('status').className = 'w-3 h-3 bg-green-500 rounded-full pulse-animation';
                document.getElementById('timeSource').textContent = 'Server';
                return true;
            } catch (error) {
                console.error('Time sync failed, using local time:', error);
                serverTimeOffset = 0;
                document.getElementById('status').className = 'w-3 h-3 bg-yellow-500 rounded-full';
                document.getElementById('timeSource').textContent = 'Local';
                return false;
            }
        }

        function getAccurateTime() {
            return Date.now() + serverTimeOffset;
        }

        function hmacSHA1(key, message) {
            const encoder = new TextEncoder();
            const keyData = encoder.encode(key);
            const messageData = encoder.encode(message);
            
            return crypto.subtle.importKey(
                'raw',
                keyData,
                { name: 'HMAC', hash: 'SHA-1' },
                false,
                ['sign']
            ).then(key => {
                return crypto.subtle.sign('HMAC', key, messageData);
            }).then(signature => {
                return Array.from(new Uint8Array(signature))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('')
                    .toUpperCase();
            });
        }

        async function generateQR() {
            const accurateTime = getAccurateTime();
            const timestamp = Math.floor(accurateTime / 1000 / 5).toString();
            
            try {
                const hmacHash = await hmacSHA1(CARD_ID, timestamp);
                const dynamicPart = hmacHash.substring(0, 8);
                const qrData = `GM2:${CARD_ID}:CUI:${timestamp}:${dynamicPart}`;
                
                // Update UI
                document.getElementById('timestamp').textContent = timestamp;
                document.getElementById('dynamicPart').textContent = dynamicPart;
                document.getElementById('qrData').textContent = qrData;
                
                // Generate QR Code
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                
                QRCode.toCanvas(qrContainer, qrData, {
                    width: 256,
                    margin: 2,
                    color: {
                        dark: '#1e40af',
                        light: '#ffffff'
                    }
                }, function (error) {
                    if (error) {
                        qrContainer.innerHTML = '<p class="text-red-500">Error generating QR</p>';
                    }
                });
                
                // Reset countdown
                countdown = 5;
                updateCountdown();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('qrcode').innerHTML = '<p class="text-red-500">Generation failed</p>';
            }
        }

        function updateCountdown() {
            document.getElementById('timer').textContent = `Next update in: ${countdown}s`;
            
            if (countdownInterval) clearInterval(countdownInterval);
            
            countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('timer').textContent = `Next update in: ${countdown}s`;
                
                if (countdown <= 0) {
                    generateQR();
                }
            }, 1000);
        }

        // Initialize
        async function init() {
            await syncServerTime();
            generateQR();
            
            // Sync time every 5 minutes
            timeSyncInterval = setInterval(syncServerTime, 300000);
        }

        init();
    </script>
</body>
</html>
